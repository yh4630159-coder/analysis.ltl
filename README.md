1. 系统概览 (System Overview)
版本号：V4.0 (上帝视角全景版)

核心目标：解决多服务商（WP, LG, AI, WL）、多部门、多月份库存数据格式不统一的问题，实现自动化清洗、全景透视、趋势对比及风险预警。

技术栈：Python + Streamlit + Pandas + Altair + Openpyxl。

运行机制：无数据库模式（In-Memory），基于文件名元数据进行逻辑关联。

2. 模块结构拆解 (Module Breakdown)
整个程序可以自上而下分为 三个逻辑层：

第一层：配置与基础设施 (Config & Infrastructure)
这部分定义了系统的“世界观”和“标准”。

COLUMN_MAPS (数据字典)：

作用：抹平不同服务商（如万邑通 vs 乐仓）表头名称的差异。

逻辑：将 实际发货仓库、仓库、Warehouse 统一映射为标准字段 Warehouse。

AGE_BINS & AGE_LABELS (库龄标准)：

作用：统一库龄分段口径（如 0-30天, 360天+）。

逻辑：使用 Pandas cut 函数将连续的天数离散化为 7 个标准段位。

第二层：ETL 数据处理引擎 (Data Engine)
这部分是系统的“心脏”，负责把杂乱的 Excel 变成干净的 DataFrame。

parse_filename(filename) (元数据解析器)

输入：业务一部_AI_2024-02.xlsx

输出：Dept="业务一部", Provider="AI", Date="2024-02"

作用：实现“文件名即数据源”，免去用户手动打标签。

load_data_v4(file) (核心清洗函数)

智能表头定位：针对 WL (万邑通) 等表头不在第一行的情况，自动扫描前 20 行，匹配关键词（SKU, Warehouse）来锁定表头位置。

数据清洗：

列名重命名（基于 COLUMN_MAPS）。

缺失值填充（fillna 0）。

数据类型转换（转为数值型，防止计算报错）。

衍生计算：自动计算 Age_Range（库龄段）。

第三层：前端视图与交互 (UI & Interaction)
这部分是用户看到的“脸面”，分为侧边栏和两大核心 Tab。

3.1 侧边栏 (Sidebar)
批量上传：支持多文件同时拖入。

进度反馈：加载后的成功提示。

3.2 Tab 1: 全景详情 (Snapshot View)
核心场景：查当下、查细节、查异常。

级联筛选器 (The Funnel)：

逻辑：部门 -> 日期 -> 服务商 -> 仓库。

特点：上一级选定后，下一级只会显示相关的选项（例如选了“业务一部”，就不会出现“业务二部”才用的服务商）。支持“全部汇总”选项。

KPI 仪表盘：总库存、总体积、总费用。

库龄结构表：按库龄段聚合，展示费用占比。

🔍 异常深钻模块 (Top 20)：

常规模式：列出当前筛选范围内费用最高的 20 个 SKU。

🔥 宏观聚合模式 (Aggregation)：

触发条件：当勾选 🔀 SKU 宏观聚合。

逻辑：忽略仓库/部门差异，将同一 SKU 的数据合并（费用叠加、库龄平均）。

价值：抓出跨仓、跨部门的“隐形亏损大户”。

3.3 Tab 2: 历史趋势 (Trend View)
核心场景：看走势、看管理成效、抓恶化。

多月筛选：st.multiselect 允许用户选择 2 个或更多月份进行横向对比。

管理层 KPI：

单位仓租成本 (CPU)：总费用 / 总件数，衡量供应链效率。

潜在节省 (Savings)：360天+ 库存的总费用，量化清理呆滞的收益。

高级图表 (Altair)：

簇状柱形图：对比同一库龄段在不同月份的库存量变化。

堆叠柱形图：展示费用构成的变化。

折线图：CPU 的走势。

🚨 恶化预警雷达 (The Drifters)：

逻辑：Merge 前后两个月的数据 -> 比较库龄段索引（Index） -> 筛选出 Index_New > Index_Old 的 SKU。

输出：正在变坏的 SKU 清单。

3. 文件命名与使用规范 (User Guide)
为了保证程序能正确运行，需严格遵守以下 SOP：

文件格式：推荐 .csv (速度快) 或 .xlsx。

命名规则：必须包含三个要素，用下划线连接。

格式：部门名称_服务商代码_日期

示例：Amazon团队_WL_2024-03.csv

服务商代码支持：AI, WL, LG, WP (大小写均可)

操作流程：

步骤 1：将所有要分析的文件（比如最近 3 个月的所有报表）放在一个文件夹。

步骤 2：打开网页，将这些文件一次性全选拖入侧边栏。

步骤 3：等待解析完成（出现 ✅ 提示），开始切换 Tab 分析。

4. 环境依赖 (Requirements)
如果在本地部署，请确保安装以下库：

Bash
pip install streamlit pandas openpyxl altair matplotlib
(注：V4.0 回退到了 V3.4 之前的稳定逻辑，不需要 matplotlib 做底层绘图支持，但建议装上以防万一；Altair 是核心绘图库。)
